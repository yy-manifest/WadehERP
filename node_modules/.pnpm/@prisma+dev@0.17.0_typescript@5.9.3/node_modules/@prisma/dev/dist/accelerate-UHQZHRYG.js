import{b as i,d as E,e as d}from"./chunk-7EOUKLQR.js";import"./chunk-EPFUMVT3.js";import{HTTPException as ae}from"hono/http-exception";import{Hono as oe}from"hono/tiny";import{validator as p}from"hono/validator";import{array as k,literal as B,minLength as U,object as N,pipe as D,safeParse as F,string as Q,union as X}from"valibot";var Y=N({tags:X([D(k(Q()),U(1)),B("all")])});async function O(e){let{output:n,success:t}=F(Y,await e.req.json(),{abortEarly:!0});return t?n:e.text("Invalid input",400)}import{parseDuration as v,parseSize as z,Server as G}from"@prisma/query-plan-executor";import{version as P}from"@prisma/query-plan-executor";var T;async function x(e){return T===void 0&&(T=await G.create({databaseUrl:e.get("db").connectionString,maxResponseSize:z("128 MiB"),queryTimeout:v("PT5M"),maxTransactionTimeout:v("PT5M"),maxTransactionWaitTime:v("PT5M"),perRequestLogContext:{logFormat:"text",logLevel:e.get("debug")?"debug":"off"}})),T}import{Buffer as I}from"buffer";import{getSchema as W,printSchema as K}from"@mrleebo/prisma-ast";var l=new Map;async function H(e){let t=new TextEncoder().encode(e),r=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(s=>s.toString(16).padStart(2,"0")).join("")}function C(e){let n=e.req.param("schemaHash"),t=l.get(n);return t==null?e.json({EngineNotStarted:{reason:"SchemaMissing"}},404):{schemaHash:n,schemas:t}}async function R(e,n,t){let r=I.from(e,"base64").toString("utf8"),a=W(r),o=a.list.find(c=>c.type==="datasource");if(!o)throw new Error("No datasource block found in schema.");let s=o.assignments.find(c=>c.type==="assignment"&&c.key==="url");s?s.value=`"${n.toString()}"`:o.assignments.push({key:"url",type:"assignment",value:`"${n.toString()}"`});let m=K(a);t&&console.log("[Accelerate] schema with override:",m);let S=await H(m);return{base64Override:I.from(m,"utf8").toString("base64"),overrideHash:S}}function g(e){let{req:n}=e;return{traceparent:n.header("traceparent"),"X-capture-telemetry":n.header("X-capture-telemetry")}}import{integer as q,looseObject as J,minValue as A,number as b,object as Z,optional as ee,pipe as _,safeParse as M,string as $,union as te}from"valibot";var ne=Z({isolation_level:ee($()),max_wait:_(b(),q(),A(0)),timeout:_(b(),q(),A(0))});async function V(e){let{issues:n,output:t,success:r}=M(ne,await e.req.json(),{abortEarly:!0});return r?t:e.json({EngineNotStarted:{reason:"InvalidRequest",issues:n}},400)}var re=J({id:te([$(),b()])});function j(e,n){let{output:t,success:r}=M(re,e);return r?t:n.json({EngineMalfunction:{}},500)}var y=new oe;y.post("/invalidate",p("header",i),async e=>{let n=await O(e);return n instanceof Response?n:e.body(null)});var se="/:clientVersion/:schemaHash",f=y.basePath(se);y.route("/",f);var ie=["/graphql","/itx/:transactionId/graphql"];f.on("POST",[...ie],p("header",i),async e=>{let{req:n}=e;try{let t=await w(e);if(t instanceof Response)return t;let r=await n.text(),a=n.param("transactionId"),o=await t.request(r,{...g(e),"X-transaction-id":a});return e.text(o)}catch(t){return d(t,e)}});f.basePath("/itx/:transactionId").on("POST",["/commit","/rollback"],p("header",i),async e=>{let{req:n}=e;try{let t=await w(e);if(t instanceof Response)return t;let a=`${n.routePath.split("/").filter(Boolean).at(-1)}Transaction`,o=n.param("transactionId"),s=await t[a](o,g(e));return e.json(s)}catch(t){return d(t,e)}});f.put("/schema",p("header",i),async e=>{let{req:n}=e,t=await n.text();if(!t)return e.text("Missing schema",400);let r=n.param("schemaHash"),a=l.get(r);if(a==null){if(r!==await H(t))return e.text("Schema hash mismatch",400);let o=await R(t,e.get("db").prismaORMConnectionString,e.get("debug"));return l.set(r,{base64Original:t,...o}),e.text(r)}return t!==a.base64Original?e.text("Schema mismatch",400):e.text(r)});f.post("/transaction/start",p("header",i),async e=>{let{req:n}=e,t=await V(e);if(t instanceof Response)return t;try{let r=await w(e);if(r instanceof Response)return r;let a=await r.startTransaction(t,g(e)),o=j(a,e);if(o instanceof Response)return o;let{id:s}=o,m=n.param("clientVersion"),S=e.get("port"),c=e.get("protocol"),L=n.param("schemaHash");return e.json({...a,"data-proxy":{endpoint:`${c}://localhost:${S}/${m}/${L}/itx/${s}`}})}catch(r){return d(r,e)}});async function w(e){let{req:n}=e,t=C(e);if(t instanceof Response)return t;let{base64Override:r,overrideHash:a}=t.schemas;return await E.get({base64Schema:r,clientVersion:process.env.PRISMA_DEV_FORCE_CLIENT_VERSION||n.param("clientVersion"),debug:e.get("debug"),platform:e.get("platform"),schemaHash:a})}var ce=[["/connection-info","GET"],["/query","POST"],["/transaction/start","POST"],["/transaction/:transactionId/commit","POST"],["/transaction/:transactionId/query","POST"],["/transaction/:transactionId/rollback","POST"]];for(let[e,n]of ce)y.on(n,e,p("header",i),async t=>{let r=t.req.header("prisma-engine-hash");if(r!=="0.0.0"&&r!==P)throw new ae(400,{message:`Using an HTTP connection string is not supported with Prisma Client version ${r} by this version of \`prisma dev\`. Please either use a direct TCP connection string or upgrade your client to version ${P}.`});return await(await x(t)).fetch(t.req.raw)});export{y as accelerateRoute};
